---
layout: pr
date: 2023-09-06
title: "transport abstraction"
pr: 28165
authors: [sipa]
components: ["p2p"]
host: glozow
status: upcoming
commit:
---

## Notes

- Bitcoin nodes "speak" a P2P protocol, which includes a way of interpreting bytes sent over
  connections to one another as well as expectations for the contents of those messages peers are expected to send to each
  other. Within Bitcoin Core, the implementations of these two parts of the protocol live in largely
separate areas of the code. At a high level:

    - The "net processing" layer includes application logic such as
      [responding](https://github.com/bitcoin/bitcoin/blob/083316c4fe20819fbe627c5d21f1a627e10af329/src/net_processing.cpp#L4677-L4694)
    to `ping` with a `pong` containing the same nonce and
[disconnecting](https://github.com/bitcoin/bitcoin/blob/083316c4fe20819fbe627c5d21f1a627e10af329/src/net_processing.cpp#L4074-L4077)
a peer that sends a transaction after we told them not to.

    - The "net" layer "below" net processing abstracts away the details of converting
      messages to/from bytes that are sent and received on the connection.

- Within the `ProcessMessage` function which responds to pings with pongs, The `ping` is a
  `CNetMessage` retrieved from `CNode::PollMessage`, and the `pong` is sent by calling
  `CConnman::PushMessage`.

- [`CConnman::SocketSendData`](https://github.com/bitcoin/bitcoin/blob/master/src/net.cpp#L836) is
  the function that actually sends data over the connection. It is called by the [socket handler
thread](https://github.com/bitcoin/bitcoin/blob/083316c4fe20819fbe627c5d21f1a627e10af329/src/net.cpp#L2416)
and sometimes by [message handler
thread](https://github.com/bitcoin/bitcoin/blob/083316c4fe20819fbe627c5d21f1a627e10af329/src/net.cpp#L2441)
from `PushMessage` (an "opportunistic write") if the message queue was empty.

- This PR is a prerequisite of [PR #28196](https://github.com/bitcoin/bitcoin/pull/28196)
  implementing [BIP324](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki), a new
transport version. While nodes still send the same types of messages and respond to pings with pongs
in the same way, the way messages are converted to/from bytes is very different.

- This PR creates an abstract `Transport` class, combining the current `TransportDeserializer` and
  `TransportSerializer` classes into a single interface for converting bytes to/from messages.

- A combined interface means that `V2Transport` can have state shared between the
serializer and deserializer, such as the `BIP324Cipher` for encrypting/decrypting messages. It may
be helpful to see how `V2Transport` is implemented in that PR.  Also see a [previous
approach](https://github.com/bitcoin/bitcoin/pull/24545), which kept the serializer and deserializer
separate and
[stored](https://github.com/bitcoin/bitcoin/pull/24545/files#diff-422879cc8bfac56d4380c865f381b58afeb344bc355bbc7f47c581e4491b6b4bR551)
state in the `CNode` object.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?

1. What is the distinction between "net" and "net processing"? What data structures and tasks might
   we associate with each of them?

1. What does it mean for `CNetMessage` to be "transport protocol agnostic"?

1. When we call `PushMessage` from `SendMessages`, have we sent the bytes corresponding to this
   message to the peer already (yes/no/maybe)? Why?

1. Which threads access `CNode::vSendMsg`?

1. Prior to this PR, why are `TransportSerializer` and `TransportDeserializer` different classes?
   Why should they be combined?

1. Commit [`27f9ba23`](https://github.com/bitcoin/bitcoin/pull/28165/commits/27f9ba23efe82531a465c5e63bf7dc62b6a3a8db)
adds an internal `m_recv_mutex` for protecting receiving state. The commit message also mentions
that an *external* mutex is needed. Why? (Hint: is it ok for `vRecv` to change in between calling
`ReceivedMessageComplete` and `GetReceivedMessage`?)

1. At a high level, what does the added [fuzz test](https://github.com/bitcoin/bitcoin/pull/28165/commits/009ff8d65058430d614c9a0e0e6ae931b7255c37) do? What kinds of bugs would it catch?

1. Commit
   [`bb4aab90`](https://github.com/bitcoin/bitcoin/pull/28165/commits/bb4aab90fd046f2fff61e082a0c0d01c5ee31297)
moves the code using `m_transport` to convert the message to bytes from `PushMessage` to
`SocketSendData`. What are the behavior changes in this commit?

1. Commit
   [`bb4aab90`](https://github.com/bitcoin/bitcoin/pull/28165/commits/bb4aab90fd046f2fff61e082a0c0d01c5ee31297) mentions "removing the assumption that a message can always immediately be converted to wire bytes." What happens in `SocketSendData` if `m_transport` isn't able to convert messages?

<!-- TODO: After a meeting, uncomment and add meeting log between the irc tags.
## Meeting Log

### Meeting 1

{% irc %}
-->
<!-- TODO: For additional meetings, add the logs to the same irc block. This ensures line numbers keep increasing, avoiding hyperlink conflicts for identical line numbers across meetings.
### Meeting 2

-->
{% endirc %}
