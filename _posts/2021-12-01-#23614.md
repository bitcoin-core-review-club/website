---
layout: pr
date: 2021-12-01
title: "Add unit test for block-relay-only eviction"
pr: 23614
authors: [mzumsande]
components: ["tests"]
host: glozow
status: upcoming
commit:
---

## Notes

* Block-relay-only is a type of outbound P2P connection: the node initiates a P2P connection to
  another peer with `fRelay` set to false in the `version` message, indicating that it does not wish
to receive unconfirmed transactions. The node will also not relay addrs with this peer.

    - By default, nodes maintain connections to two block-relay-only peers (introduced in [PR #15759](https://github.com/bitcoin/bitcoin/pull/15759)).

    - [PR #19858](https://github.com/bitcoin/bitcoin/pull/19858) introduced a new routine to
      regularly initiate temporary, block-relay-only connections with new peers and sync headers, in
an effort to make eclipse attacks more difficult. We discussed this PR in a previous review club,
[#19858](/19858).

* [PR #23614](https://github.com/bitcoin/bitcoin/pull/23614) adds a unit test for the extra
  block-relay-only eviction logic.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

2. `EvictExtraOutboundPeers()` selects outbound peers to evict when the number of connections exceeds
our limit. Is this normal? How can this happen?

3. What are block-relay-only peers? What are *extra* block-relay-only peers?

4. Describe the eviction logic for extra block-relay-only peers.

    4a. (Bonus) Compare the [extra block-relay-only eviction
logic](https://github.com/bitcoin-core-review-club/bitcoin/blob/93a0ec1a629af533bb21418a3e134c268bc57395/src/net_processing.cpp#L3962)
with the [extra full-relay eviction
logic](https://github.com/bitcoin-core-review-club/bitcoin/blob/93a0ec1a629af533bb21418a3e134c268bc57395/src/net_processing.cpp#L4002).

    4b. (Bonus #2) Compare the [extra outbound eviction
logic](https://github.com/bitcoin-core-review-club/bitcoin/blob/pr19858/src/net_processing.cpp#L3954)
with the [normal outbound eviction
logic](https://github.com/bitcoin-core-review-club/bitcoin/blob/pr19858/src/net_processing.cpp#L3901).  When do we care about block announcement recency, and when do we care about ping time? Why?

5. What is `MINIMUM_CONNECT_TIME`? Why do we wait a period of time before considering a peer for
eviction?

6. The unit test
   [checks](https://github.com/bitcoin-core-review-club/bitcoin/blob/4c449a55c29b4b382660852b20800d0ae2bc9e22/src/test/denialofservice_tests.cpp#L232-L234)
the `fDisconnect` values of peers in order to test eviction logic, and
[prevents the peer from being disconnected](https://github.com/bitcoin-core-review-club/bitcoin/blob/4c449a55c29b4b382660852b20800d0ae2bc9e22/src/test/denialofservice_tests.cpp#L239)
by setting `fDisconnect` to false. Why is this appropriate? Why don't we wait for the peers to be
disconnected, like in the
[p2p\_eviction.py](https://github.com/bitcoin-core-review-club/bitcoin/blob/pr23614/test/functional/p2p_eviction.py)
functional test?

7. Why does the test need to
   [call](https://github.com/bitcoin-core-review-club/bitcoin/blob/4c449a55c29b4b382660852b20800d0ae2bc9e22/src/test/denialofservice_tests.cpp#L251)
`FinalizeNode()`?

8. How often is `CheckForStaleTipAndEvictPeers` executed? In unit tests, can we trigger it to run
automatically by using `SetMockTime()` to fast-forward?

9. Can a block-relay-only peer become a full-relay peer?


<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
