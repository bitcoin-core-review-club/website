---
layout: pr
date: 2023-04-05
title: "MiniTapscript: port Miniscript to Tapscript"
pr: 27255
authors: [darosior]
components: ["descriptors"]
host: josibake
status: upcoming
commit: 6e3b37b
---

## Notes

### Background and prior work

_Miniscript_ is a language for writing (a subset of) Bitcoin Scripts in a structured way, enabling analysis, composition, generic signing and more. _Miniscript_ support in Bitcoin Core has been an ongoing effort, with watch-only support for Miniscript in P2WSH descriptors added in `v24.0.1` and signing support to be added in the upcoming `v25`. For background:

* [https://bitcoin.sipa.be/miniscript](https://bitcoin.sipa.be/miniscript) gives an overview of the Miniscript language
* [#24147](https://github.com/bitcoin/bitcoin/pull/24147) provides the rationale and initial backbone needed for Miniscript support in Bitcoin Core
* [#24148](https://github.com/bitcoin/bitcoin/pull/24148) adds watch-only support for Miniscript descriptors (see previous review club [#24148](/24148))
* [#24149](https://github.com/bitcoin/bitcoin/pull/24149) adds signing support for Miniscript descriptors

### TapMiniscript

While [_Tapscript_](https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki) shares most operations with legacy Bitcoin Script, there are a few [notable differences](https://bitcoinops.org/en/topics/tapscript/). As such, _TapMiniscript_ has been a project to support Tapscript in Miniscript. For background:

* [This gist](https://gist.github.com/sipa/06c5c844df155d4e5044c2c8cac9c05e) contains the initial design and discussion on supporting Miniscript in Tapscript
* [#134](https://github.com/sipa/miniscript/pull/134/) adds Tapscript support in Miniscript

### Putting it all together

Putting it all together, this PR adds support for Tapscript in Miniscript in Bitcoin Core and makes Miniscript available inside `tr()` descriptors, both with watching and signing support.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?

1. In your own words, what are some of the differences between Segwit v0 Script (Bitcoin Script with the Segwit Soft Fork rules) and Tapscript rules that may be relevant to Miniscript? Why?

1. What is Tapscript?

1. This PR [adds](https://github.com/bitcoin-core-review-club/bitcoin/commit/c0ba8ebbf6369b37b645165bb5cd638fc7eee67f) a `multi_a` fragment for Tapscript. How is this different than the existing `multi` fragment? Does it have the same properties as `multi`? Why?

1. In Miniscript, we have type modifiers, which guarantee additional properties for an expression. [866284d](https://github.com/bitcoin-core-review-club/bitcoin/commit/866284d007993551f681809d9e48175a3b0fe0c1) makes "**d**" have the "**u**" property under Tapscript.
	* What are the "**d**" and "**u**" type modifiers?
	* Why is it that we can make **d** have the **u** property here? Why not in non-Tapscript Miniscript?

1. This PR adds some logic for statically ensuring no spending path exceeds the stack size at execution time:
	* Why does this matter for Tapscript?
	* What's the approach taken by this PR? What are the pros/cons? (hint: [efdd154](https://github.com/bitcoin-core-review-club/bitcoin/commit/efdd1543597aff49c56a1abaa75b574be3b330db))
	* Can you think of an alternative approach to ensure no spending path exceeds the stack size?

1. In [e81635c](https://github.com/bitcoin-core-review-club/bitcoin/commit/e81635c39d99a158629544fefd765b3994f3d7c4), the scripts are optionally padded during fuzzing. Why?

1. What is the most significant change to the descriptor logic in this PR (hint: [08db38a](https://github.com/bitcoin-core-review-club/bitcoin/commit/08db38aca2fe9169b39507d928c1094be2116ad4)). Why is it needed?


<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
