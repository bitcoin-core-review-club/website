---
layout: pr
date: 2025-06-18
title: "Improve TxOrphanage denial of service bounds"
pr: 31829
authors: [glozow]
components: ["p2p"]
host: glozow
status: upcoming
commit: 0d511965c91
---

## Notes

- The [PR description](https://github.com/bitcoin/bitcoin/pull/31829#issue-2840961349) summarizes the motivations for
  this change and the new eviction strategy: we must ensure the orphanage is DoS-resistant, but also want to prevent any
peer from affecting another peer's usage of orphanage space.

- The PR does a few things: virtualizes the `TxOrphanage` class inherited by `TxOrphanageImpl`, implements a new
  eviction strategy, rewrites `TxOrphanage` the data structure(s) as a single `boost::multi_index_container`.

- With these PR's changes, we can now "guarantee" at least 1 ancestor package worth of orphan resolution per peer at a
  time. A fuzz test, `txorphan_protected`, and a few functional tests check this. Also, if most peers are not
providing orphans, the unused space allocated to them can be used by more useful peers.

- An earlier version of this PR implemented the new eviction strategy using the existing `TxOrphanage` data structures.
  You can find that version of the PR [here](https://github.com/glozow/bitcoin/tree/2025-05-copy-31829).

## Questions

### Concept

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?

1. Why is the current 100-transaction global limit with random eviction problematic? Can you think of a concrete attack scenario for 1p1c relay?

1. Can you summarize the changes to the eviction algorithm at a high level?

1. Why is it desirable to allow peers to exceed their individual limits while the global limits are not reached?

1. The new algorithm evict announcements instead of transactions. What is the difference and why does it matter?

1. Why is there an announcement "limit" but a memory *"reservation"*?

1. How does the per-peer memory usage reservation change as the number of peers increases?

1. How does the per-peer announcement limit change as the number of peers increases? This is different from the per-peer memory usage reservation - why?

1. Going back to your attack scenario from an earlier question, how does this change improve the reliability of 1p1c relay in adversarial environments?

### Implementation

1. What is the purpose of reimplementing `TxOrphanageImpl` using a `boost::multi_index_container` along with the eviction changes?

1. What is a peer "DoS Score" and how is it calculated?

1. The global memory limit scales with the number of peers. Could this create new DoS vectors where an attacker opens many connections to increase the global limit?

1. Is it possible for the orphanage to `NeedsTrim()` but there is no peer whose DoS score is greater than 1?

1. Is it possible that a peer's DoS score is greater than 1 but `NeedsTrim()` returns false?

1. When evicting orphans, why [evict](https://github.com/bitcoin-core-review-club/bitcoin/commit/498f1c019197a8e4105490cdc4a0605594ca97d5#diff-e6100361fa0e9e25478f808ca084e5f681d4dddbbee7b3bea0f9d5bcd29db3aaR457) non-reconsiderable orphans before reconsiderable ones? What's the difference between these categories?

1. How does the number of announcements represent a meaningful bound on "computation" in `TxOrphanage` operations?

1. What is the computational complexity of the `LimitOrphans` [loop](https://github.com/bitcoin-core-review-club/bitcoin/commit/498f1c019197a8e4105490cdc4a0605594ca97d5#diff-e6100361fa0e9e25478f808ca084e5f681d4dddbbee7b3bea0f9d5bcd29db3aaR433-R478)? How many heap operations can there be? How many erasures can there be?

1. How can we test (and do test exist?): `TxOrphanage`'s internal data structures are updated correctly, its DoS limits are correctly enforced, and "honest" peers' orphans are protected from eviction?

1. How does the `txorphan_protected` [fuzzer](https://github.com/bitcoin-core-review-club/bitcoin/commit/05e6241be627aa0152698f5f71adfacd790df58d) test that orphans are protected from eviction?

1. The default announcement limit is [increased](https://github.com/bitcoin-core-review-club/bitcoin/commit/5e86bb8b2914d43112a568d04fbbdb14036b70a6) from 100 to 3000. How was this number chosen and what are the tradeoffs?


<!-- TODO: After a meeting, uncomment and add meeting log between the irc tags
## Meeting Log

### Meeting 1

{% irc %}
-->
<!-- TODO: For additional meetings, add the logs to the same irc block. This ensures line numbers keep increasing, avoiding hyperlink conflicts for identical line numbers across meetings.

### Meeting 2

-->
{% endirc %}
