---
layout: pr
date: 2021-11-10
title: "Coalesce Chainstate loading sequence between {,non-}unittest codepaths"
pr: 23280
authors: [dongcarl]
components: ["refactoring"]
host: jnewbery
status: upcoming
commit: b8ea88926c
---

_Notes and questions to follow soon!_

## Notes

- [init.cpp](https://github.com/bitcoin/bitcoin/blob/77a2f5d30/src/init.cpp)
  is responsible for the startup sequence for bitcoind and bitcoin-qt. It
  parses and sanitizes configuration options, initializes the various
  components, starts threads, and so on.

- For historic reasons, the initialization code is complex and difficult to work
  with - the file is very long (1861 lines prior to this PR), the individual
  functions within the file are long (for example,
  [AppInitMain](https://github.com/bitcoin/bitcoin/blob/77a2f5d30/src/init.cpp#L1112)
  is 750 lines) and there's global state being read and written.

- The code is also brittle - since various components and global state
  depend on each other, even innocuous-looking changes that re-order events
  in minor ways can cause subtle changes in behaviour. This has been the
  source of several bugs in the past.

- To make matters worse, the code in init.cpp is difficult to unit test.
  Since it's tightly coupled with lots of other parts of the codebase, it's
  difficult to isolate and test thoroughly. The unit tests have their own
  code for initializing their test setup, so the code is not shared between
  bitcoind initialization code and unit test initialization.

- [PR 23280](https://github.com/bitcoin/bitcoin/pull/23280) is an attempt to 
  unify some of the initialization logic for the validation state. If that
  code is shared between bitcoind and the unit tests, then it'll be better
  tested and less likely to be broken by future changes.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. This PR distinguishes between "soft failures" and "hard failures" when
   loading the chainstate. What is the difference between those two?

1. The first commit (_init: Extract chainstate loading sequence_) touches a
   large number of lines and extracts logic from `AppInitMain()` into a
   dedicated `LoadChainstateSequence()` function. How did you satisfy
   yourself that this commit didn't introduce any behaviour changes?

1. Commit _init/chainstate: Decouple from stringy errors_ changes the return
   type of `LoadChainstateSequence()` from a boolean to an (optional) enum.
   How did you satisfy yourself that the commit didn't introduce any
   behaviour changes?

1. In the same commit, why are the `failed_chainstate_init` and
   `failed_verification` local variables removed? What were they used for
   previously? Why are they no longer required?

1. In the same commit, `fLoaded` is no longer passed into
   `LoadChainstateSequence()` (as a reference), and is now set in the outer
   `AppInitMain()` function. Why is this possible?

1. In commit _init/chainstate: Remove do/while loop_, the do/while loop is
   removed from `LoadChainstateSequence()`. Why is this possible? What was
   it being used for prior to this PR?

1. Commit _init/chainstate: Decouple from concept of uiInterface_ adds this
   code to the call site for `LoadChainstateSequence()`:

   ```
   []() {
       uiInterface.ThreadSafeMessageBox(
  	 _("Error reading from database, shutting down."),
  	 "", CClientUIInterface::MSG_ERROR);
   },
   []() {
       uiInterface.InitMessage(_("Verifying blocksâ€¦").translated);
   });
   ```

   What is that syntax? What is being passed in to the function?

1. Commit _validation: Call NotifyBlockTip in CCS::LoadChainTip_ removes a
   call to `RPCNotifyBlockChange()` and adds a call to
   `uiInterface.NotifyBlockTip()`. How are those two functions related?

<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
